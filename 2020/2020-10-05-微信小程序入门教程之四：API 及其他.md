# 微信小程序入门教程之四：API 及其他

这个教程的前三篇介绍了小程序开发基础、页面样式和脚本编程，今天介绍小程序提供的各种 API。

## 一、WXML 渲染语法

WXML 是小程序的页面标签语言，它不仅提供了许多功能标签，还有一套自己的语法，可以为页面渲染设置生效条件和循环处理。

比如，`home.js`里面的数据源是一个数组。

```javascript
Page({
  data: {
    items: ['事项 A', '事项 B', '事项 C']
  }
});
```

上面代码中，通过数据绑定变成全局变量的`items`是一个数组。页面渲染这个数据时，不必一项项写代码，WXML 提供了循环处理的语法。

打开`home.wxml`，改成下面的代码。

```html
<view>
  <text class="title" wx:for="{{items}}">
    {{index}}、 {{item}}
   </text>
</view>
```

上面代码中，`<text>`的`wx:for`属性，表示将循环处理`items`数组的每一项，数组有多少项就会生成多少个`<text>`。渲染后的页面结构如下。

```html
<view>
  <text>...</text>
  <text>...</text>
  <text>...</text>
</view>
```

在循环体内，当前数组成员的位置序号绑定变量`index`，值绑定变量`item`。

开发者工具导入项目代码，页面渲染结果如下。

![](https://www.wangbase.com/blogimg/asset/202010/bg2020100507.jpg)

WXML 的其他渲染语法，请查看[官方文档](https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/list.html)。

## 二、客户端数据储存

小程序允许将数据保存在用户的客户端里面。用户下次打开的时候，就可以从客户端读取这些数据。

打开`home.wxml`，改成下面的代码。

```html
<view>
  <text class="title" wx:for="{{items}}">
    {{index}}、 {{item}}
   </text>
   <input placeholder="输入新增事项" bind:input="inputHandler"/>
   <button bind:tap="buttonHandler">确定</button>
</view>
```

上面代码新增了一个输入框和一个按钮，用意是把用户输入的事项，储存在本机客户端。这样的话，下次打开页面时，就会显示上次输入的内容。

需要注意的是，输入框有一个`input`事件的监听函数，按钮有一个`tap`事件的监听函数。这两个函数负责处理用户的输入，我们放在后面解释。

开发者工具导入项目代码，页面渲染结果如下。

![](https://www.wangbase.com/blogimg/asset/202010/bg2020100509.jpg)

然后，打开`home.js`，代码修改如下。

```javascript
Page({
  data: {
    items: [],
    inputValue: ''
  },
  inputHandler(event) {
    this.setData({
      inputValue: event.detail.value || ''
    });
  },
  buttonHandler(event) {
    const newItem = this.data.inputValue.trim();
    if (!newItem) return;
    const itemArr = [...this.data.items, newItem];
    wx.setStorageSync('items', itemArr);
    this.setData({ items: itemArr });
  },
  onLoad() {
    const itemArr = wx.getStorageSync('items') || []; 
    this.setData({ items: itemArr });
  }
});
```

上面代码中，`inputHandler()`是用户输入时的回调函数，具体的输入文字可以从事件对象的`event.detail.value`属性拿到。

`buttonHandler()`是用户点击按钮时的回调函数，该函数使用`wx.setStorageSync()`方法，将用户的输入存储在客户端，然后使用`this.setData()`方法更新一下页面。

`onLoad()`属于页面的生命周期方法，页面加载后会自动执行该方法。它只执行一次，用于页面初始化，意图是每次用户打开页面，都通过`wx.getStorageSync()`方法，从客户端储存取出以前输入的数据，显示在页面上。

小程序存入本地储存的`wx.setStorageSync()`方法接受两个参数，分别是键名和键值；读取本地储存的`wx.getStorageSync()`方法，只有一个参数，就是键名。这两个方法都是同步的，小程序也提供异步版本，请参考[官方文档](https://developers.weixin.qq.com/miniprogram/dev/api/storage/wx.setStorage.html)。

必须牢记的是，客户端储存是不可靠的，随时可能消失，而且用户换了一台手机，或者本机重装微信，也无法读取。所以，它只适合保存一些不重要的临时数据，最常见的用途一般就是将网络资源保存到本地，加快页面显示。

## 三、远程数据请求

小程序可以向外部服务器发送请求，读取或发送数据。一旦小程序具备了网络能力，就能发挥出最大的作用。

每个小程序都必须到后台登记，需要跟哪些外部服务器进行通信，否则无法通信。不过，开发者工具允许开发时放松这个限制，点击右上角的三条横线，选中“不校验合法域名、web-view(业务域名)、tls 版本以及 HTTPS 证书” 即可。这样的话，小程序在开发时就可以跟本地服务器进行通信。

下面，我们在本地起一个开发服务器。为了简单起见，我选用了 [json-server](https://www.npmjs.com/package/json-server) 作为本地服务器，它的好处是只要有一个 JSON 数据文件，就能自动生成 RESTful 接口。

首先，新建一个数据文件`db.json`，内容如下。

```javascript
{
  "items": ["事项 A", "事项 B", "事项 C"]
}
```

然后，确认本机安装了 Node.js 以后，进入`db.json`所在的目录，在命令行执行下面命令。

```bash
npx json-server db.json
```

正常情况下，这时在浏览器访问`localhost:3000/items`，就能返回一个数组`["事项 A", "事项 B", "事项 C"]`。


