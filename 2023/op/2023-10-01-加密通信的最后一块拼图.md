## 加密通信的最后一块拼图

十一长假中，世界最大的 CDN 服务商 Cloudflare 发了[一篇博客文章](https://blog.cloudflare.com/announcing-encrypted-client-hello/)，宣称解决了“加密通信的最后一块拼图”。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101508.webp)

这件事挺重要的，可能会影响很多人，本周我想好好谈谈。

这是纯粹的技术话题，我尽量说得通俗。如果你不想了解细节问题，可以直接看最后一段。

我先问大家，通过 HTTPS 链接访问互联网，这是加密通信吗？

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101601.webp)

你可以说它是，因为通信内容确实是加密的，外界无法窥测和篡改。

但是，很多人不知道，它并不是彻底的加密通信，**有一个地方是不加密的，那就是域名**。别人可以看到，你访问什么网站。

具体来说，我们向服务器发起通信时，必须在最开始的握手阶段，明文告诉服务器，我们要访问的域名。

这种设计不是失误，而是合理的。服务器只有知道域名，才能把对应的密钥传给用户，后者再拿这把密钥去加密通信。拿到密钥之前，是没有办法加密的。

这种在 HTTPS 的握手阶段，明文发送域名的机制，称为 SNI。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101602.webp)

所以，域名从一开始就是不加密的，**只有解决这个问题，才算解决“加密通信的最后一块拼图”。**

但是，要对域名加密，用户必须在连接到服务器之前，就拿到密钥。这个问题一直没有解，直到加密 DNS 的出现。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101603.webp)

DNS 的作用，是将域名转成 IP 地址。访问服务器之前，必须先向 DNS 服务器查询域名的 IP 地址。

那么，**只要能从 DNS 服务器上获取域名的密钥，不就可以对域名加密了吗？**

以前，DNS 是明文通信，这件事没法做。但是从2016年开始，加密 DNS 标准出台，密钥就可以放到 DNS 上了。

举例来说，要访问网站`crypto.dance`，DNS 服务器上有该域名的 IP 地址，同时还有一个子域名（比如`_esni.crypto.dance`）的 TXT 记录，里面存放的就是密钥。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101703.webp)

Cloudflare 就是借助这一点，实现了一个全新的加密机制，叫做 ECH。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101704.webp)

ECH 使用从 DNS 获取的密钥，对 HTTPS 握手信息里面的域名进行加密，从而解决了“加密通信的最后一块拼图”。

有意思的地方是，**为了保持最大的兼容性，ECH 采用的是双层格式**。它有两层，外层是不加密的，跟以前一样，存放一个明文的域名，Cloudflare 用的是`cloudflare-ech.com`，内层才是加密的，存放你要访问的真正域名。

外界只能看到你在访问`cloudflare-ech.com`，看不到内层的域名。

但是，这让我产生了一个疑问，也是今天写这段话题的主要原因。我想知道，如果 cloudflare-ech.com 发生故障，无法访问，那么所有托管在 Cloudflare 的网站是否都无法访问？

Cloudflare 是世界最大 CDN 服务商，托管了许许多多网站。更恶心的是，它对所有免费用户启用了 ECH，还无法关闭，而付费用户没有启用，等于是让免费用户当小白鼠。

下面就是我要说的话，**如果托管在 Cloudflare 的网站无法访问，有两个解决办法**：一种是站长向它付费，关了 ECH，另一种是告诉用户不要使用加密 DNS，没有了它，就不会触发 ECH。

---

现在就实现了，**在访问某个网站之前，拿到它的密钥，也就可以对域名进行加密了**。

所以，加密 DNS 出现之后，很快就有了完全加密的 HTTPS 请求，域名也是加密的，这叫做 ESNI 格式（即加密的 SNI）。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101604.webp)

但是，esin 有一些技术问题，同时跟现有的许多设置不兼容，所以 Cloudflare 用了一段时间后，就决定放弃 ESNI，发明另一种格式 ECH。

![](https://cdn.beekka.com/blogimg/asset/202310/bg2023101605.webp)

ECH 是一个很有趣的格式。它采用双层域名，外面的域名是明文的，连向 cloudflare-ech.com，内层的域名是加密的，才是真正要访问的网址。

中间人只能看到外层域名，以为你是访问 cloudflare-ech.com，而发现不了你的真正目的地。


===

esni 会加密域名。

两个缺点：

- 缓存密钥会过时
- 前提是必须使用 DNS over TLS 或 DNS over HTTPS。因为密钥是从 DNS 获取的，如果 DNS 不加密，sni 加密就毫无意义。而且，密钥必须经常发生变化。

例如，要获取 crypto.dance 的密钥，客户端将请求 _esni.crypto.dance 的 TXT 记录：

$ dig _esni.crypto.dance TXT +short
"/wGuNThxACQAHQAgXzyda0XSJRQWzDG7lk/r01r1ZQy+MdNxKg/mAqSnt0EAAhMBAQQAAAAAX67XsAAAAABftsCwAAA="

ECH 细节 https://blog.cloudflare.com/encrypted-client-hello/

建议：如果你要访问 Cloudflare 上面的网站，建议不要开启 DOH，担心会触发 ECH。

===


1、[Cloudflare 启用 ECH，隐藏访问网址](https://blog.cloudflare.com/announcing-encrypted-client-hello/)（英文）

很多人不知道，加密通信协议 HTTPS 并不加密域名（即不加密协议的握手阶段），中间人能看到你访问什么网站，只是看不到通信内容。

世界最大 CDN 服务商 Cloudflare 宣布，推出一个协议扩展 ECH，默认对托管的所有网站启用，可以隐藏你要访问的网址。

![](https://cdn.beekka.com/blogimg/asset/202309/bg2023093001.webp)

它的方法就是，把网址用公钥加密，然后把请求发到 cloudflare-ech.com，由它来解密。外界只会看到你在访问 Cloudflare，但不知道你的真正目的地。

![](https://cdn.beekka.com/blogimg/asset/202309/bg2023093002.webp)

我看了以后，不禁有一个疑问：假如 cloudflare-ech.com 无法访问，是不是所有托管在 Cloudflare 的网站都无法访问？另外，这个设计虽然是开放的，但是有很多前提条件，基本上只对 Cloudflare 可行，其他人部署意义不大。