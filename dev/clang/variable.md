# 变量

## 简介

变量（varible）可以理解成一块内存区域的名字。我们通过变量名，引用这块内存区域，获取里面保存的值。由于保存的值可能发生变化，所以称为变量。如果保存的值不会发生变化，那就是常量。

变量名在 C 语言里面属于标识符（identifier），如何取名有严格的规范，除了能够清晰地表示意图，还必须遵守下面的规范。

- 只能由字母（包括大写和小写）、数字和下划线（`_`）组成。
- 不能以数字开头。
- 长度不能超过63个字符。

下面是一些无效变量名的例子。

```c
$zj
j**p
2cat
Hot-tab
tax rate
don't
```

上面示例里面，每一行的变量名都是无效的。

变量名区分大小写，`star`、`Star`、`STAR`都是不同的变量。

并非所有的词都能用作变量名，有些词在 C 语言里面有特殊含义（比如`int`），另一些词是命令（比如`continue`），它们都称为关键字，不能用作变量名。另外，C 语言还保留了一些词，可能供未来使用，这些保留字也不能用作变量名。下面就是 C 语言主要的关键字和保留字。

> auto, break, case, char, const, continue, default, do, double, else, enum, extern, flosat, for, goto ,if ,inline,int, long, register, restrict, return, short, signed, sizeof, static, struct, typedef, union, unsigned, void, volatile, while

## 变量的声明

C 语言的变量，必须先声明后使用。如果一个变量没有声明，就直接使用，C 语言会报错。

声明的时候，必须把变量的类型告诉编译器。

```c
int height;
```

上面代码声明了变量`height`，并且指定类型为`int`（整数）。

如果几个变量具有相同类型，可以在同一行声明。

```c
int height, width;

// 等同于
int height;
int width;
```

注意，声明变量的语句必须以分号结尾。

## 变量的赋值

C 语言会在变量声明时，就为它分配内存空间。但是，变量具体是什么值，必须等到使用赋值运算符（`=`）进行赋值时，才会写入已经分配好的内存之中。

```c
int num;
num = 42;
```

上面示例中，第一行声明了一个整数变量`num`，第二行给这个变量赋值。

变量的声明和赋值，也可以写在一行。

```c
int num = 42;
```

注意，赋值表达式有返回值，等于等号右边的值。

```c
int x, y;

x = 1;
y = (x = 2 * x);
```

上面代码中，变量`y`的值就是赋值表达式（`x = 2 * x`）的返回值。

由于赋值表达式有返回值，所以 C 语言可以写出多重赋值表达式。

```c
int x, y, z, m, n;

x = y = z = m = n = 3;
```

上面的代码是合法代码，一次为多个变量赋值。赋值运算符是从右到左执行，所以先为`n`赋值，然后依次是`m`、`z`、`y`和`x`。

注意，C 语言不会在变量声明时自动清除内存。如果只声明变量、不进行赋值的话，该变量的值就会是该内存区域原来留存的值。这一点务必需要小心。

## 块作用域

大括号组成的代码块，形成一个单独的作用域，称为”块作用域“（block scope）。凡是在块作用域里面声明的变量，作用域外不可见。

```c
int a = 12;

if (a == 12) {
  int b = 99;
  printf("%d %d\n", a, b);  // 12 99
}

printf("%d\n", a);  // 12
printf("%d\n", b);  // 出错
```

上面例子中，变量`b`是在`if`代码块里面声明的，所以对于大括号外面的代码，这个变量是不存在的。

如果代码块内部还有代码块，那么也是同样的规则：里层代码块可以使用外层声明的变量，外层不可以使用内层声明的变量。内层如果有外层的同名变量，那么会在当前作用域中覆盖外部变量。

```c
int i = 10;

{
  int i = 20;
  printf("%d\n", i);  // 20
}

printf("%d\n", i);  // 10
```

上面示例中，内层和外层都有一个变量`i`，每个作用域都会优先使用当前作用域声明的`i`。另外，单独使用大括号，就可以构成一个作用域。

最常见的块作用域就是函数，函数内部声明的变量，对于函数外部是不可见的。

`for`循环也是一个块作用域，循环变量只对循环体内部可见，外部是不可见的。

```c
for (int i = 0; i < 10; i++)
  printf("%d\n", i);

printf("%d\n", i); // 出错
```

比较特殊的是，`for`的循环条件部分是一个单独的作用域，跟循环体内部不是同一个作用域。

```c
for (int i = 0; i < 5; i++) {
  int i = 999;
  printf("%d\n", i);
}
```

上面示例中，`for`的循环变量是`i`，循环体内部也声明了一个变量`i`，会优先读取。但由于循环条件部分是一个单独的作用域，所以循环体内部的`i`不会修改掉循环变量`i`，因此这段代码的运行结果就是打印5次`999`。

上面示例中，`for`循环外部是拿不到循环变量的。

一旦块作用域运行结束，内部声明的变量也就消失了。

## 文件作用域

块作用域外部声明的变量，只在当前文件可见，其他源码文件无法使用，这称为文件作用域（file scope）。



声明一个变量时，前面可以加上三类修饰词。

- 类型符（Type specifier）：变量的类型
- 储存符（Storage class）：变量储存在哪里
- 修饰符（Type qualifier）：一些其他属性

类型符有以下几种。

- void
- char
- short
- int
- long
- long long
- signed
- unsigned
- float
- double
- struct
- enum
- union

储存符有以下几种。

- extern
- static
- register
- auto
- typedef

类型符有以下几种。

- const
- volatile
- restrict

## 变量声明的解读规则

- 首先，找出变量名
- 然后，从后向前解读
- 圆括号具有最高优先级
- 变量后边如果有`[]`，表示数组；如果有`()`，表示函数。
- `*`表示`pointer to`，即“指向xxx的指针”。

`int (*x)[12];`是“x is a pointer to an array of 12 int”，而`int *x[12];`是“x is an array of 12 pointer to int”

## 储存符

`extern`表示，变量储存在外部，没有必要为它分配空间。通常用来表示，声明在不同文件里面的全局变量。

`static`对于全局变量和局部变量有不同含义。如果用于局部变量，表示在同一个函数的不同执行之间，保持它的值，不会随着每次执行而初始化。它的行为类似于全局变量，但只在函数内部可用。用于局部变量时，表示变量对于其他C文件并非全局可用，即该变量不会被链接（link）。总得来说，`static`声明的变量都是无法从它所在的源文件之外读取的。

`register`表示变量应该储存在寄存器之中。编译器不一定会遵守这个建议。对于`register`声明的变量，不能取它的地址，即不能使用`&`运算符。

`auto`表示这个变量的储存由编译器自主分配。它没有实际作用。因为只要不是`extern`，都是由编译器自主分配的。

`typedef`用来为某种类型声明一个别名。

```c
typedef int *xpto;
```

上面代码中，`xpto`就代表`int *`。

```c
xpto x;
```

前面不能再加其他修饰符。

```c
unsigned xpto x; /* 无效 */
```

## 修饰符

### const

`const`命令表示变量不可修改。

```c
int *const x
```

如果它的前面有`*`，表示指针变量`x`不可修改。

```c
int const *x
# 或者
const int *x
```

如果`const`在`*`前面，则表示`*x`所代表的那个值不可修改。

这两者可以结合起来。

```c
const char **const*const x;
```

### volatile

`volatile`表示它所声明的变量，可能不预期地发生变量，不受C的实现的控制，因此编译器不要对这类变量进行优化。硬件设备的编程中，这个命令很常用，表示。

```c
while (x,x) { ... }
```

上面代码中，如果`x`是一个`volatile`变量，则编译器会真的对`x`计算两次值。否则，编译器会将上面的代码优化如下。

```c
while (x) { ... }
```

### restrict

`restrict`命令表示它所声明的变量，是唯一接触到其所代表的内存区域的途径。这对编译器优化很有好处。

## 赋值

变量声明之后，并没有初始化，里面的值都是随机分配的，必须通过赋值的方式获得值。千万不要假定没有赋值的变量为`0`。

```c
int height;

height = 8;
```

上面的代码将变量`height`赋值为`8`。

如果变量为`float`类型，赋值时要带上小数点。而且，小数点后面最好还要加上`f`，告诉编译器该变量为`float`类型。

```c
height = 2.83f;
```

可以在声明变量的同时，对该变量进行赋值。

```c
int height = 8;
```

同一个声明语句中，可以对多个变量进行赋值。

```c
int height = 8, width = 10;
```

也可以对一些变量赋值，另一些变量不赋值。

```c
int height = 8, width;
```

## 参考链接

- [The absolute, definitive guide to decipher C declarations](http://codinghighway.com/2013/12/29/the-absolute-definitive-guide-to-decipher-c-declarations/), by Filipe Gonçalves
