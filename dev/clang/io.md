# 输入与输出

输入（import）指的是获取外部数据，输出（export）指的是向外部传递数据。C 语言提供了很多用于输入和输出的函数，常用的有下面这些。

## 缓存和字节流

大多数文件都是保存在磁盘上面，跟 CPU 相比，磁盘读取或写入数据是一个很慢的操作，所以程序直接读写磁盘是不可行的。C 语言的解决方案，就是在内存里面设置一个缓存区（buffering）。

程序向磁盘写入数据时，程序先把数据放入缓存，等到缓存满了，缓存里面的数据会一次性写入磁盘文件。然后，程序再把新的数据放入缓存，重复整个过程。

程序从磁盘读取数据时，磁盘文件先把一部分数据放到缓存里面，然后程序从缓存获取数据，等到缓存空了，磁盘文件再把新的数据放入缓存，重复整个过程。

这样的设计大大提高了程序的读写效率，因为缓存是在内存里面，读写的速度很快。另外，一次性移动大块数据，要比多次移动小块数据快得多。

这种读写模式，对于程序来说，就有点像水流（stream）式的操作，不是一次性读取或写入所有数据，而是一个持续不断的过程。先操作一部分数据，等到缓存吞吐完这部分数据，再操作下一部分数据。这个过程就叫做字节流操作。

C 语言的输入输出函数，凡是涉及读写文件，都是属于字节流操作。调用这些函数的时候，系统会自动为它们创建缓存，建立字节流。输入函数从文件获取数据，操作的是输入流；输出函数向文件写入数据，操作的是输出流。

## printf()

`printf()`是最常用的输出函数，用于屏幕输出，详见《基本语法》一章。

## scanf()

### 基本用法

`scanf()`函数用于读取用户的键盘输入。程序运行到这个语句时，会停下来，等待用户从键盘输入。用户输入数据、按下回车键后，`scanf()`就会处理用户的输入，将其存入变量。

由于 C 语言的变量都是有类型的，所以`scanf()`必须提前知道用户输入的数据类型，才能处理数据。所以，`scanf()`的第一个参数是一个格式字符串，里面会放置占位符，告诉编译器如何解读用户的输入，需要提取的数据是什么类型。`scanf()`的其余参数就是存放用户输入的变量，格式字符串里面有多少个占位符，就有多少个变量。

```c
scanf("%d", &i)
```

上面示例中，`scanf()`的第一个参数`%d`，表示用户输入的应该是一个整数。`%d`就是一个占位符，`%`是占位符的标志，`d`表示整数。第二个参数`&i`表示，将用户从键盘输入的整数存入变量`i`。

注意，普通变量前面必须加上`&`运算符，因为`scanf()`传递的不是值，而是地址，即将变量`i`的地址改为用户输入的值的地址。如果赋值的是指针变量（比如字符串变量），那就不用加`&`运算符。

下面是多个变量的例子。

```c
scanf("%d%d%f%f", &i, &j, &x, &y);
```

上面示例中，格式字符串`%d%d%f%f`，表示用户输入的前两个是整数，后两个是浮点数，比如`1 -20 3.4 -4.0e3`。这四个值依次放入`i`、`j`、`x`、`y`四个变量。

`scanf()`处理数值占位符时，会自动过滤空白字符，包括空格、制表符、换行符等。所以，用户也可以使用回车键，将输入分成几行。

```c
1
-20
3.4
-4.0e3
```

上面示例中，用户分成四行输入，得到的结果与一行输入是完全一样的。

`scanf()`处理用户输入的原理，是将用户的输入先放入缓存，然后按照占位符对缓存进行解读，占位符的具体格式与`printf()`的占位符是一致的。解读用户输入时，会从上一次解读遗留的第一个字符开始，直到遇到第一个不符合条件的字符为止。

```c
int x;
float y;

// 用户输入 "    -13.45e12# 0"
scanf("%d", &x);
scanf("%f", &y);
```

上面示例中，`scanf()`读取用户输入时，`%d`占位符会忽略起首的空格，从`-`处开始获取数据，读取到`-13`，然后停下来，因为后面的`.`不属于整数的有效字符。这就是说，占位符`%d`会读到`-13`。

第二次调用`scanf()`时，就会从上一次停止解读的地方，继续往下读取。这一次读取的首字符是`.`，由于对应的占位符是`%f`，会读取到`-13.45e12`，这是采用科学计数法的浮点数格式。后面的`#`不属于浮点数的有效字符，所以会停在这里。

由于`scanf()`可以连续处理多个占位符，所以上面的例子也可以写成下面这样。

```c
scanf("%d%f", &x, &y);
```

`scanf()`的返回值是一个整数，表示成功读取的项数。如果没有读取任何项，或者匹配失败，则返回`0`。如果读取到文件结尾，则返回 EOF。

### 占位符

`scanf()`常用的占位符如下。

- `%c`：字符。
- `%d`：整数。
- `%f`：`float`类型浮点数。
- `%lf`：`double`类型浮点数。
- `%Lf`：`long double`类型浮点数。
- `%s`：字符串。

上面所有占位符之中，除了`%c`以外，都会自动忽略起首的空白字符。`%c`不忽略空白字符，总是返回当前第一个字符，无论该字符是否为空格。如果要强制跳过字符前的空白字符，可以写成`scanf(" %c", &ch)`，即`%c`前加上一个空格，表示跳过零个或多个空白字符。

下面要特别说一下占位符`%s`，它其实不能简单地等同于字符串。它的规则是，从当前第一个非空白字符开始读起，直到遇到空白字符（即空格、换行符、制表符等）为止。因为`%s`不会包含空白字符，所以无法用来读取多个单词，除非多个`%s`一起使用。这也意味着，`scanf()`不适合读取可能包含空格的字符串，比如书名或歌曲名。另外，`scanf()`遇到`%s`占位符，会在字符串变量末尾存储一个空字符`\0`。

`scanf()`将字符串读入数组时，不会检测字符串是否超过了数组长度。所以，储存字符串时，很可能会超过数组的边界，导致预料不到的结果。为了防止这种情况，使用`%s`占位符时，应该指定读入字符串的最长长度，即写成`%[m]s`，其中的`[m]`是一个数字，表示读取字符串的最大长度，后面的字符将被丢弃。

```c
char name[11];
scanf("%10s", name);
```

上面示例中，`name`是一个长度为11的字符数组，`scanf()`的占位符`%10s`表示最多读取用户输入的10个字符，后面的字符将被丢弃，这样就不会有数组溢出的风险了。

## sscanf()

`sscanf()`函数与`scanf()`很类似，不同之处是`sscanf()`从字符串里面，而不是从`stdin`获取数据。它的原型定义在头文件`stdio.h`里面。

```c
int sscanf(const char* s, const char* format, ...);
```

`sscanf()`的第一个参数是一个字符串指针，用来从其中获取数据。其他参数都与`scanf()`相同。

`sscanf()`主要用来处理其他输入函数读入的字符串，从其中提取数据。

```c
fgets(str, sizeof(str), stdin);
sscanf(str, "%d%d", &i, &j);
```

上面示例中，`fgets()`先从标准输入获取了一行数据，存入变量`str`。然后，`sscanf()`再从`str`里面提取两个整数，放入变量`i`和`j`。

`sscanf()`的一个好处是，它的数据来源不是流数据，所以可以反复使用，不像`scanf()`的数据来源是流数据，只能读取一次。

`sscanf()`的返回值是成功赋值的变量的数量，如果提取失败，返回 EOF。

## getchar()，putchar()

`getchar()`函数返回用户从键盘输入的一个字符，使用时不带有任何参数。程序运行到这个命令就会暂停，等待用户从键盘输入，等同于使用`scanf()`方法读取一个字符。

```c
char ch;
ch = getchar();

// 等同于
char ch;
scanf("%c", &ch);
```

`getchar()`不会忽略起首的空白字符，总是返回当前读取的第一个字符，无论是否为空格。如果读取识别，返回 EOF。

由于`getchar()`返回读取的字符，所以可以用在循环条件之中。

```c
while (getchar() != '\n')
  ;
```

上面示例中，只有读到的字符等于换行符（`\n`），才会退出循环，常用来跳过某行。`while`循环的循环体没有任何语句，表示对该行不执行任何操作。

下面的例子是计算某一行的字符长度。

```c
int len = 0;
while(getchar() != '\n')
  len++;
```

上面示例中，`getchar()`每读取一个字符，长度变量`len`就会加1，直到读取到换行符为止，这时`len`就是该行的字符长度。

下面的例子是跳过空格字符。

```c
while ((ch = getchar()) == ' ')
  ;
```

上面示例中，结束循环后，变量`ch`等于第一个非空格字符。

`putchar()`函数将它的参数字符输出到屏幕，等同于使用`printf()`输出一个字符。

```c
putchar(ch);
// 等同于
printf("%c", ch);
```

操作成功时，`putchar()`返回输出的字符，否则返回 EOF。

由于`getchar()`和`putchar()`这两个函数用法更简单，而且通常是用宏来实现，所以要比`scanf()`和`printf()`更快。它们的原型定义在`stdio.h`头文件中。

## puts()

`puts()`函数用于将参数字符串显示在屏幕（stdout）上，并且自动在字符串末尾添加换行符。

```c
puts("Here are some messages:");
puts("Hello World");
```

上面示例中，`puts()`在屏幕上输出两行内容。

写入成功时，`puts()`返回一个非负整数，否则返回 EOF。

## gets()

`gets()`函数以前用于从`stdin`读取整行输入，现在已经被废除了，仍然放在这里介绍一下。

该函数读取用户的一行输入，不会跳过起始处的空白字符，直到遇到换行符为止。这个函数会丢弃换行符，储存其余字符，并在这些字符的末尾添加一个空字符`\0`，使其成为一个字符串。

它经常与`puts()`配合使用。

```c
char words[81];

puts("Enter a string, please");
gets(words);
```

上面示例使用`puts()`在屏幕上输出提示，然后使用`gets()`获取用户的输入。

由于`gets()`获取的字符串，可能超过变量的最大长度，有安全风险，建议不要使用。下面的`fgets()`的用法，可以代替`gets()`。

```c
fgets(str, sizeof(str), stdin);
```

## fgets()，fputs()

`fgets()`函数用于读取输入的字符串。该函数专门设计用于处理文件输入，所以它的名字的第一个字符是`f`，代表`file`。

`fgets()`的第一个参数是储存字符串的变量名。

`fgets()`的第二个参数指定读取的字符串长度，防止用户输入过长的字符串。如果该参数是`n`，那么`fgets()`会读取到`n - 1`个字符为止，或者读取到第一个换行符为止。`fgets()`会将换行符储存在字符串中，这一点需要注意。

`fgets()`函数的第三个参数是要读取的文件。如果是读取键盘输入的数据，则使用`stdin`（标准输入）作为参数。

`fputs()`函数通常与`fgets`配对使用，用于输出字符串，常用来向文件写入内容。`fputs()`的用法与`puts()`类似，只有一点不同，那就是它不会在字符串末尾添加换行符。

`fputs()`的第一个参数是字符串变量，第二个参数是要写入的文件名。如果是要输出到计算机屏幕上，则使用`stdout`（标准输出）作为第二个参数。

```c
char words[14];

puts("Enter a string, please.");
fgets(words, 14, stdin);

puts("This is your string:");
fputs(words, stdout);
```

`fgets()`返回一个指向字符串的指针。如果一切顺利，返回的地址与第一个参数相同。但是，如果发生错误，或者读到了文件结尾，它将返回一个空指针（null pointer）。这个指针不会指向有效的数据，可以用宏 NULL 代替。使用这一点可以判断，是否读到了文件结尾。

```c
char words[10];

puts("Enter strings (q to quit):");

while (fgets(words, 10, stdin) != NULL) {
  if (words[0] == 'q' && words[1] == '\n')
    break;

  fputs(words, stdout);
}

puts("Done.");
```

上面的示例中，如果用户输入的字符串大于9个字符，`fgets()`会多次读取。如果希望丢弃那些多余的字符，可以参考下面的例子。

```c
char words[10];
int i;

puts("Enter strings (q to quit):");

while (fgets(words, 10, stdin) != NULL) {
  if (words[0] == 'q' && words[1] == '\n')
    break;

  fputs(words, stdout);

  i = 0;
  while (words[i] != '\n' && words[i] != '\0')
    i++;

  if (words[i] == '\0') {
    while (getchar() != '\n') continue;
    fputs("\n", stdout);
  }
}

puts("Done.");
```

上面示例中，如果用户输入的字符串大于9个字符（不含最后的换行符），多于9个字符的部分使用`getchar()`从缓存中读出并丢弃。由于丢弃时不会输出最后的换行符，所以丢弃结束后补输出一个换行符。

## gets_s()

`gets_s()`函数与`fgets()`类似，使用一个参数限制读入的字符串。

```c
gets_s(words, StrLen);
```

它与`fgets()`的区别是：

- `gets_s()`只从标准输入中读取数据，所以不需要第3个参数。
- `gets_s()`读到换行符，会丢弃它，不进行保存。
- `gets_s()`如果读到最大字符串，都没有读到换行符。它会将目标数组的第一个字符设为 null 字符，读取并丢弃随后的输入，直至读到换行符或文件结尾，然后返回空指针。接着，调用处理函数，可能会中止或退出程序。

## Stream

文件必须先打开，才能读取或写入。

C 语言提供三个默认已经打开的文件。

- stdin	标准输入，通常默认情况下为键盘
- stdout	标准输出，通常默认情况下为屏幕
- stderr	标准错误，通常也是默认情况下的屏幕

下面两种写法是等价的。

```c
printf("Hello, world!\n");
fprintf(stdout, "Hello, world!\n");
```

`printf()`是直接写入`stdout`，而`fprint`是指定写入文件`stdout`。

